<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        const {
            URL
        } = window

        function getFaviconForPageURL(
            url, isSyncedUrlForHistoryUi, remoteIconUrlForUma = '', size = 16) {
            // Note: URL param keys used below must match those in the description of
            // chrome://favicon2 format in components/favicon_base/favicon_url_parser.h.
            const faviconUrl = getBaseFaviconUrl();
            faviconUrl.searchParams.set('size', size);
            faviconUrl.searchParams.set('page_url', url);
            // TODO(dbeam): use the presence of 'allow_google_server_fallback' to
            // indicate true, otherwise false.
            const fallback = isSyncedUrlForHistoryUi ? '1' : '0';
            faviconUrl.searchParams.set('allow_google_server_fallback', fallback);
            if (isSyncedUrlForHistoryUi) {
                faviconUrl.searchParams.set('icon_url', remoteIconUrlForUma);
            }

            return getImageSet(faviconUrl.toString());
        }

        function getBaseFaviconUrl() {
            const faviconUrl = new URL('chrome://favicon2/');
            faviconUrl.searchParams.set('size', '16');
            faviconUrl.searchParams.set('scale_factor', 'SCALEFACTORx');
            return faviconUrl;
        }

        /**
         * Generates a CSS -webkit-image-set for a chrome:// url.
         * An entry in the image set is added for each of getSupportedScaleFactors().
         * The scale-factor-specific url is generated by replacing the first instance
         * of 'scalefactor' in |path| with the numeric scale factor.
         *
         * @param {string} path The URL to generate an image set for.
         *     'scalefactor' should be a substring of |path|.
         * @return {string} The CSS -webkit-image-set.
         */
        function getImageSet(path) {
            const supportedScaleFactors = getSupportedScaleFactors();
            debugger

            const replaceStartIndex = path.indexOf('SCALEFACTOR');
            if (replaceStartIndex < 0) {
                return getUrlForCss(path);
            }

            let s = '';
            for (let i = 0; i < supportedScaleFactors.length; ++i) {
                const scaleFactor = supportedScaleFactors[i];
                const pathWithScaleFactor = path.substr(0, replaceStartIndex) +
                    scaleFactor + path.substr(replaceStartIndex + 'scalefactor'.length);

                s += getUrlForCss(pathWithScaleFactor) + ' ' + scaleFactor + 'x';

                if (i !== supportedScaleFactors.length - 1) {
                    s += ', ';
                }
            }
            return '-webkit-image-set(' + s + ')';
        }

        /**
         * @return {!Array<number>} The scale factors supported by this platform for
         *     webui resources.
         */
        function getSupportedScaleFactors() {
            const isIOS = false, isAndroid = false
            const supportedScaleFactors = [];
            if (!isIOS) {
                // This matches the code in ResourceBundle::InitSharedInstance() that
                // supports SCALE_FACTOR_100P on all non-iOS platforms.
                supportedScaleFactors.push(1);
            }
            if (!isIOS && !isAndroid) {
                // All desktop platforms support zooming which also updates the renderer's
                // device scale factors (a.k.a devicePixelRatio), and these platforms have
                // high DPI assets for 2x.  Let the renderer pick the closest image for
                // the current device scale factor.
                supportedScaleFactors.push(2);
            } else {
                // For other platforms that use fixed device scale factor, use
                // the window's device pixel ratio.
                // TODO(oshima): Investigate corresponding to
                // ResourceBundle::InitSharedInstance() more closely.
                supportedScaleFactors.push(window.devicePixelRatio);
            }
            return supportedScaleFactors;
        }

        /**
         * Generates a CSS url string.
         * @param {string} s The URL to generate the CSS url for.
         * @return {string} The CSS url string.
         */
        function getUrlForCss(s) {
            // http://www.w3.org/TR/css3-values/#uris
            // Parentheses, commas, whitespace characters, single quotes (') and double
            // quotes (") appearing in a URI must be escaped with a backslash
            const s2 = s.replace(/(\(|\)|\,|\s|\'|\"|\\)/g, '\\$1');
            return `url("${s2}")`;
        }

        window.getFaviconForPageURL = getFaviconForPageURL
    </script>
</body>

</html>